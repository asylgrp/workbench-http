parameters:
    env(WORKB_ORG_NAME): "Unknown organization"
    env(WORKB_BASE_DIR): "."
    env(WORKB_DECISIONS_DIR): "decisions"
    env(WORKB_ACCESS_LOG): "access-log.txt"
    env(WORKB_ACCESS_FORMAT): '%h %u %t %T "%r" %>s %b'
    env(WORKB_ERROR_LOG): "error-log.txt"
    env(WORKB_ERROR_LEVEL): "notice"

imports:
    - { resource: event_dispatcher.yaml }
    - { resource: service_layer.yaml }

services:
    _defaults:
        public: false
        autowire: true

    workbench\webb\:
        resource: '../src/*'
        exclude: '../src/{DependencyInjection/ProjectServiceContainer.php}'

    workbench\webb\Http\Route\:
        resource: '../src/Http/Route/*'
        public: true

    Psr\Http\Server\RequestHandlerInterface:
        class: inroutephp\inroute\Runtime\Middleware\Pipeline
        public: true
        arguments:
            - '@workbench\webb\Http\Middleware\ExceptionEndpoint'
            - '@workbench\webb\Http\Middleware\ExceptionPrettifier'
            - '@workbench\webb\Http\Middleware\ExceptionLogger'
            - '@Middlewares\AccessLog'
            - '@Middlewares\TrailingSlash'
            - '@Middlewares\Robots'
            - '@workbench\webb\Http\HttpRouter'

    workbench\webb\Http\Middleware\ExceptionLogger:
        class: ~
        arguments: ['@error_logger']

    error_logger:
        class: Monolog\Logger
        arguments: ['error']
        calls:
            - method: pushHandler
              arguments: ['@error_logger_stream']

    error_logger_stream:
        class: Monolog\Handler\StreamHandler
        arguments: ['%env(WORKB_BASE_DIR)%/%env(WORKB_ERROR_LOG)%', '%env(WORKB_ERROR_LEVEL)%']

    Middlewares\AccessLog:
        class: ~
        arguments: ['@access_logger']
        calls:
            - method: format
              arguments: ['%env(WORKB_ACCESS_FORMAT)%']

    access_logger:
        class: Monolog\Logger
        arguments: ['access']
        calls:
            - method: pushHandler
              arguments: ['@access_logger_stream']

    access_logger_stream:
        class: Monolog\Handler\StreamHandler
        arguments: ['%env(WORKB_BASE_DIR)%/%env(WORKB_ACCESS_LOG)%']

    Middlewares\TrailingSlash: ~

    Middlewares\Robots:
        class: ~
        arguments: [false]

    workbench\webb\Http\HttpRouter:
        class: ~
        calls:
            - method: setContainer
              arguments: ['@Psr\Container\ContainerInterface']

    Psr\Container\ContainerInterface:
        class: workbench\webb\DependencyInjection\ProjectServiceContainer

    Psr\Http\Message\ResponseFactoryInterface:
        class: Zend\Diactoros\ResponseFactory
        public: true

    Money\MoneyFormatter:
        class: Money\Formatter\DecimalMoneyFormatter

    Money\MoneyParser:
        class: Money\Parser\DecimalMoneyParser

    Money\Currencies:
        class: Money\Currencies\ISOCurrencies

    Mustache_Engine:
        class: Mustache_Engine
        arguments:
            -
                loader: '@Mustache_Loader_FilesystemLoader'

    Mustache_Loader_FilesystemLoader:
        class: Mustache_Loader_FilesystemLoader
        arguments: ['templates']
